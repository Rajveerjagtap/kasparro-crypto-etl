# Render.com Deployment Configuration
# =====================================
# This file defines the infrastructure-as-code for deploying Kasparro
# to Render's free tier. Push this repo to GitHub and connect to Render.
#
# Services:
#   1. PostgreSQL Database (Free tier)
#   2. Web Service (FastAPI API - Public endpoint)
#   3. Background Worker (ETL Scheduler - Cron jobs)
#
# To deploy:
#   1. Push code to GitHub
#   2. Go to https://render.com
#   3. New > Blueprint > Connect your repo
#   4. Render will auto-detect this render.yaml

databases:
  # PostgreSQL Database - Free tier (90-day limit)
  - name: kasparro-db
    databaseName: kasparro
    user: kasparro
    plan: free
    region: oregon

services:
  # ============== Web Service (FastAPI API) ==============
  # Public API endpoint - handles HTTP requests
  - type: web
    name: kasparro-api
    runtime: docker
    plan: free
    region: oregon
    
    # Health check for zero-downtime deploys
    healthCheckPath: /health
    
    # Environment variables
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: kasparro-db
          property: connectionString
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: ENVIRONMENT
        value: "production"
      - key: LOG_LEVEL
        value: "INFO"
    
    # Docker configuration
    dockerfilePath: ./Dockerfile
    dockerContext: .
    
    # Use startup script that handles DB wait and migrations
    dockerCommand: /code/start-web.sh

  # ============== Background Worker (ETL Scheduler) ==============
  # Runs scheduled ETL jobs in the background
  - type: worker
    name: kasparro-scheduler
    runtime: docker
    plan: free
    region: oregon
    
    # Environment variables (same DB connection)
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: kasparro-db
          property: connectionString
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: ENVIRONMENT
        value: "production"
      - key: LOG_LEVEL
        value: "INFO"
      # Schedule interval: 3600 = 1 hour (adjust as needed)
      - key: SCHEDULE_INTERVAL
        value: "3600"
    
    # Docker configuration
    dockerfilePath: ./Dockerfile
    dockerContext: .
    
    # Use startup script for scheduler
    dockerCommand: /code/start-scheduler.sh
